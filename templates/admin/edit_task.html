{% from "shared/modals.html" import confirm_modal %}
{% from "shared/task_help.html" import task_help_card, task_info_card, json_examples_by_type, format_json_button %}
{% import "shared/answer_forms.html" as ans %}
{% extends "admin/base_admin.html" %}

{% block title %}Редактирование задания{% endblock %}

{% block admin_content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-info-emphasis"><i class="fas fa-edit"></i> Редактирование задания</h2>
    <div class="btn-group">
      <a href="{{ url_for('admin.tasks') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> К заданиям
      </a>
      {% if task %}
      <button type="button" class="btn btn-outline-danger" 
              data-bs-toggle="modal" 
              data-bs-target="#deleteTaskModal"
              data-task-id="{{ task.id }}"
              data-task-name="{{ task.title }}">
        <i class="fas fa-trash"></i> Удалить
      </button>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-edit"></i> Задание #{{ task.id if task else 'Новое' }}
            {% if task %}
              <span class="badge bg-{{ 'primary' if task.is_active else 'secondary' }} ms-2">
                {{ 'Активно' if task.is_active else 'Неактивно' }}
              </span>
            {% endif %}
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- Основная информация -->
            <div class="row mb-3">
              <div class="col-lg-6">
                <label for="{{ form.title.id }}" class="form-label">{{ form.title.label.text }} <span class="text-danger">*</span></label>
                {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                {% if form.title.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.title.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-3 col-lg-2">
                <label for="{{ form.max_score.id }}" class="form-label">{{ form.max_score.label.text }} <span class="text-danger">*</span></label>
                {{ form.max_score(class="form-control" + (" is-invalid" if form.max_score.errors else "")) }}
                {% if form.max_score.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.max_score.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-3 col-lg-4">
                <label for="{{ form.code.id }}" class="form-label">{{ form.code.label.text }}</label>
                {{ form.code(class="form-control" + (" is-invalid" if form.code.errors else "")) }}
                <div class="form-text">Опционально. Используется как внешний ключ при импорте попыток. Пример: <code>migr_01_123</code></div>
                {% if form.code.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.code.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Описание/условие -->
            <div class="mb-3">
              <label for="{{ form.description.id }}" class="form-label">{{ form.description.label.text }} <span class="text-danger">*</span></label>
              {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4", placeholder="Подробное условие задачи...") }}
              {% if form.description.errors %}
                <div class="invalid-feedback">
                  {% for error in form.description.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Тема, уровень, тип ответа -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="{{ form.topic_id.id }}" class="form-label">{{ form.topic_id.label.text }} <span class="text-danger">*</span></label>
                {{ form.topic_id(class="form-select" + (" is-invalid" if form.topic_id.errors else "")) }}
                {% if form.topic_id.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.topic_id.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label for="{{ form.level.id }}" class="form-label">{{ form.level.label.text }} <span class="text-danger">*</span></label>
                {{ form.level(class="form-select" + (" is-invalid" if form.level.errors else "")) }}
                {% if form.level.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.level.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label for="{{ form.answer_type.id }}" class="form-label">{{ form.answer_type.label.text }} <span class="text-danger">*</span></label>
                {{ form.answer_type(class="form-select" + (" is-invalid" if form.answer_type.errors else "")) }}
                {% if form.answer_type.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.answer_type.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

            {{ ans.render_answer_forms(form) }}

            <!-- Объяснение -->
            <div class="mb-3">
              <label for="{{ form.explanation.id }}" class="form-label">{{ form.explanation.label.text }}</label>
              {{ form.explanation(class="form-control" + (" is-invalid" if form.explanation.errors else ""), rows="3", placeholder="Подсказка или объяснение решения...") }}
              {% if form.explanation.errors %}
                <div class="invalid-feedback">
                  {% for error in form.explanation.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Активность -->
            <div class="mb-4">
              <div class="form-check">
                {{ form.is_active(class="form-check-input") }}
                <label class="form-check-label" for="{{ form.is_active.id }}">
                  {{ form.is_active.label.text }}
                </label>
              </div>
            </div>

            <!-- Кнопки -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary" id="saveBtn" disabled>
                <i class="fas fa-save"></i> Сохранить изменения
              </button>
              <a href="{{ url_for('admin.tasks') }}" class="btn btn-outline-secondary" id="cancelLink">
                <i class="fas fa-times"></i> Отмена
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Боковая панель с информацией -->
    <div class="col-lg-4">
      <!-- Информация о задании -->
      {{ task_info_card(task) }}

      <!-- Справка -->
      {{ task_help_card(show_admin_warning=True, card_title="Справка по редактированию") }}
    </div>
  </div>
</div>

{# Модальное окно удаления с использованием confirm_modal #}
{% if task %}
{% call confirm_modal(
    id='deleteTaskModal',
    title='Удаление задания',
    body='Вы действительно хотите удалить задание <strong id="deleteTaskName"></strong>?',
    action="__URL__",
    confirm_text='Удалить навсегда',
    confirm_class='btn-danger',
    alert_note='Это действие нельзя отменить. Все попытки решения этого задания также будут удалены.'
) %}
  {% if delete_form %}{{ delete_form.hidden_tag() }}{% else %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
{% endcall %}
{% endif %}

{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Настройка модального окна удаления
  const deleteModal = document.getElementById('deleteTaskModal');
  if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const taskId = button.getAttribute('data-task-id');
      const taskName = button.getAttribute('data-task-name');
      
      // Обновляем содержимое модального окна
      const taskNameElement = deleteModal.querySelector('#deleteTaskName');
      if (taskNameElement) {
        taskNameElement.textContent = taskName;
      }
      
      // Обновляем action формы
      const form = deleteModal.querySelector('form');
      if (form) {
        form.action = `/admin/tasks/${taskId}/delete`;
      }
    });
  }

  // Функция форматирования JSON
  window.formatJSON = function(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    try {
      if (field.value.trim()) {
        const parsed = JSON.parse(field.value);
        field.value = JSON.stringify(parsed, null, 2);
        field.classList.remove('is-invalid');
        
        // Показать уведомление
        showNotification('JSON отформатирован успешно', 'success');
      }
    } catch (e) {
      showNotification('Ошибка форматирования: ' + e.message, 'error');
      field.classList.add('is-invalid');
    }
  };

  // Автоматическое форматирование при потере фокуса
  const jsonFields = document.querySelectorAll('textarea[id$="_answer"], textarea[id$="_schema"]');
  
  jsonFields.forEach(field => {
    field.addEventListener('blur', function() {
      try {
        if (this.value.trim()) {
          const parsed = JSON.parse(this.value);
          this.value = JSON.stringify(parsed, null, 2);
          this.classList.remove('is-invalid');
        }
      } catch (e) {
        // Не форматируем невалидный JSON, оставляем как есть
      }
    });
  });

  // Функция показа уведомлений
  function showNotification(message, type = 'info') {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 3000);
  }

  // Трекер изменений формы + блокировка кнопки "Сохранить"
  const form = document.querySelector('form[method="POST"]');
  window.__formSubmitting = false;

  // Считать текущее состояние формы в виде объекта по именам полей
  function readFormState(f) {
    const state = {};
    if (!f) return state;

    const elements = Array.from(f.elements).filter(el => el.name && el.type !== 'submit');

    for (const el of elements) {
      // игнорируем CSRF
      if (el.name === 'csrf_token') continue;

      if (el.type === 'checkbox') {
        state[el.name] = !!el.checked;
      } else if (el.type === 'radio') {
        // для радиогруппы сохраняем выбранное значение один раз
        if (state.hasOwnProperty(el.name)) continue;
        const checked = f.querySelector(`input[type="radio"][name="${CSS.escape(el.name)}"]:checked`);
        state[el.name] = checked ? checked.value : null;
      } else {
        // нормализуем перевод строк
        state[el.name] = (el.value || '').replace(/\r\n/g, '\n');
      }
    }
    return state;
  }

  // Сравнение двух состояний
  function statesEqual(a, b) {
    const aKeys = Object.keys(a);
    const bKeys = Object.keys(b);
    if (aKeys.length !== bKeys.length) return false;
    for (const k of aKeys) {
      if (a[k] !== b[k]) return false;
    }
    return true;
  }

  const initialState = readFormState(form);
  window.__initialFormState = initialState;
  const saveBtn = document.getElementById('saveBtn');
  const cancelLink = document.getElementById('cancelLink');

  function updateDirtyUI() {
    const current = readFormState(form);
    const hasChanges = !statesEqual(initialState, current);

    // Кнопка Сохранить активна только при изменениях
    if (saveBtn) saveBtn.disabled = !hasChanges;

    // Индикатор в заголовке вкладки
    if (hasChanges) {
      if (!document.title.startsWith('* ')) document.title = '* ' + document.title;
    } else {
      document.title = document.title.replace(/^\*\s+/, '');
    }

    return hasChanges;
  }

  if (form) {
    // пометим отправку формы (для beforeunload)
    form.addEventListener('submit', function(){ window.__formSubmitting = true; });

    // Клик по Отмена не должен показывать beforeunload
    if (cancelLink) {
      cancelLink.addEventListener('click', function(){ window.__formSubmitting = true; });
    }

    // Навешиваем слушатели на все элементы формы
    form.addEventListener('input', updateDirtyUI, true);
    form.addEventListener('change', updateDirtyUI, true);

    // Первичная инициализация
    updateDirtyUI();
  }
});

// Предупреждение о несохраненных изменениях
window.addEventListener('beforeunload', function(e) {
  if (window.__formSubmitting) return; // не предупреждаем при сабмите/отмене
  const form = document.querySelector('form[method="POST"]');
  if (!form) return;
  // используем тот же детектор изменений
  const inputsChanged = (function(){
    // локальная копия функций из DOMContentLoaded
    function readFormState(f){
      const state = {}; if (!f) return state;
      const elements = Array.from(f.elements).filter(el => el.name && el.type !== 'submit');
      for (const el of elements) {
        if (el.name === 'csrf_token') continue;
        if (el.type === 'checkbox') state[el.name] = !!el.checked;
        else if (el.type === 'radio') {
          if (state.hasOwnProperty(el.name)) continue;
          const checked = f.querySelector(`input[type="radio"][name="${CSS.escape(el.name)}"]:checked`);
          state[el.name] = checked ? checked.value : null;
        } else {
          state[el.name] = (el.value || '').replace(/\r\n/g, '\n');
        }
      }
      return state;
    }
    function statesEqual(a,b){
      const aKeys = Object.keys(a); const bKeys = Object.keys(b);
      if (aKeys.length !== bKeys.length) return false;
      for (const k of aKeys){ if (a[k] !== b[k]) return false; }
      return true;
    }
    const current = readFormState(form);
    // initialState недоступен здесь напрямую, поэтому просто сравним с defaultValue/checked как запасной вариант
    // но лучше использовать скрытый слепок, если он доступен в window
    if (window.__initialFormState) return !statesEqual(window.__initialFormState, current);
    return false; // если нет слепка — не беспокоим пользователя
  })();

  if (inputsChanged) {
    e.preventDefault();
    e.returnValue = 'У вас есть несохраненные изменения. Вы действительно хотите покинуть страницу?';
  }
});
</script>
{% endblock %}