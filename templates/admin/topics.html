{% from "shared/modals.html" import confirm_modal, upload_modal %}
{% extends "admin/base_admin.html" %}

{% block title %}Управление темами{% endblock %}

{% block admin_content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-info-emphasis"><i class="fa fa-book"></i> Управление темами</h2>
    <div class="btn-group" role="group">
      <a href="{{ url_for('admin.create_topic') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Создать тему
      </a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTopicsModal">
        <i class="fas fa-upload"></i> Импорт
      </button>
      <a href="{{ url_for('admin.export_topics') }}" class="btn btn-info">
        <i class="fas fa-download"></i> Экспорт всех
      </a>
    </div>
  </div>

  {% if topics and topics|length > 0 %}
    <div class="table-container">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:36px;"><input type="checkbox" id="selectAll"></th>
            <th>Код</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Заданий</th>
            <th>Создано</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for topic in topics %}
          {% set tasks_count = task_counts.get(topic.id, 0) %}
            <tr>
              <td><input type="checkbox" class="topic-checkbox" value="{{ topic.id }}"></td>
              <td><code>{{ topic.code }}</code></td>
              <td><strong>{{ topic.name }}</strong></td>
              <td>
                {% set desc = topic.description or '' %}
                {{ desc[:100] }}{% if desc|length > 100 %}…{% endif %}
              </td>
              <td>
                <span class="badge rounded-pill {{ 'bg-info' if tasks_count > 0 else 'bg-secondary' }}">
                  {{ tasks_count }}
                </span>
              </td>
              <td>{{ topic.created_at.strftime('%d.%m.%Y') if topic.created_at else '—' }}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('admin.edit_topic', topic_id=topic.id) }}"
                     class="btn btn-outline-primary" title="Редактировать">
                    <i class="fas fa-edit"></i>
                  </a>

                  {% if tasks_count == 0 %}
                    <a href="#"
                       class="btn btn-outline-danger"
                       title="Удалить"
                       data-bs-toggle="modal"
                       data-bs-target="#deleteTopicModal"
                       data-topic-id="{{ topic.id }}"
                       data-topic-name="{{ topic.name }}">
                      <i class="fas fa-trash"></i>
                    </a>
                  {% else %}
                    <button type="button" class="btn btn-outline-secondary" disabled
                            title="Нельзя удалить: есть связанные задания">
                      <i class="fas a-lock fa-lock"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <button type="button" class="btn btn-info" onclick="exportSelected()" id="exportSelectedBtn" disabled>
        <i class="fas fa-download"></i> Экспорт выбранных
      </button>
      <span class="text-muted ms-2">Выбрано: <span id="selectedCount">0</span></span>
    </div>
  {% else %}
    <div class="alert alert-info">
      <h4 class="mb-1">Темы не найдены</h4>
      <p class="mb-3">Создайте первую тему или импортируйте темы из файла.</p>
      <a href="{{ url_for('admin.create_topic') }}" class="btn btn-primary">Создать тему</a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTopicsModal">Импорт тем</button>
    </div>
  {% endif %}

  {# URL-шаблон — подменяем action в JS при открытии модалки #}
  {% set delete_topic_url_template = "__URL__" %}

  {% set topics_format_note %}
    <div class="alert alert-info small mb-3">
      <strong>Формат:</strong>
<pre class="mb-0">[
  {
    "code": "algebra_basics",
    "name": "Основы алгебры",
    "description": "Базовые понятия",
    "level_configs": {
      "low":    {"task_count_threshold": 10, "reference_time": 900, "penalty_weights": [0.7, 0.4]},
      "medium": {"task_count_threshold": 10, "reference_time": 900, "penalty_weights": [0.7, 0.4]},
      "high":   {"task_count_threshold": 10, "reference_time": 900, "penalty_weights": [0.7, 0.4]}
    }
  }
]</pre>
    </div>
  {% endset %}

  {# confirm-модалка удаления: внутрь передаём именно поля FlaskForm #}
{% call confirm_modal(
    id='deleteTopicModal',
    title='Удаление темы',
    body='Вы действительно хотите удалить тему <strong id="deleteTopicName"></strong>?',
    action="__URL__",
    confirm_text='Удалить навсегда',
    confirm_class='btn-danger',
    alert_note='Это действие нельзя отменить.'
) %}
  {{ delete_form.hidden_tag() }}  {# ← вместо '<input value="{{ csrf_token() }}">' #}
{% endcall %}

{# upload-модалка импорта: тоже кладём hidden_tag() от ImportFileForm #}
{{ upload_modal(
    id='importTopicsModal',
    title='Импорт тем',
    action=url_for('admin.import_topics'),
    input_name='file',
    accept='.json',
    submit_text='Импортировать',
    method='post',
    csrf_html=import_form.hidden_tag(),   
    header_note=topics_format_note
) }}

{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script>
    window.TOPICS_EXPORT_URL = "{{ url_for('admin.export_topics') }}";
  </script>
  <script src="{{ url_for('static', filename='js/admin_topics.js') }}"></script>
{% endblock %}
