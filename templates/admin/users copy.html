{% from "shared/modals.html" import confirm_modal, upload_modal %}
{% extends "admin/base_admin.html" %}

{% block title %}Управление пользователями{% endblock %}

{% block admin_content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-info-emphasis"><i class="fa fa-users"></i> Управление пользователями</h2>
    <div class="btn-group" role="group">
      <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
        <i class="fas fa-user-plus"></i> Добавить пользователя
      </a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importUsersModal">
        <i class="fas fa-upload"></i> Импорт
      </button>
      <a href="{{ url_for('admin.export_users') }}" class="btn btn-info">
        <i class="fas fa-download"></i> Экспорт всех
      </a>
    </div>
  </div>

  {% if users and users|length > 0 %}
    <div class="table-container">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:36px;"><input type="checkbox" id="selectAllUsers"></th>
            <th>Логин</th>
            <th>ФИО</th>
            <th>Email</th>
            <th>Роль</th>
            <th>Статус</th>
            <th>Последний вход</th>
            <th>Создан</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr data-user-id="{{ u.id }}">
              <td><input type="checkbox" class="user-checkbox" value="{{ u.id }}"></td>
              <td><code>{{ u.username }}</code></td>
              <td>{{ u.get_full_name() }}</td>
              <td>
                {% if u.email %}
                  <a href="mailto:{{ u.email }}">{{ u.email }}</a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% set role_icon = {'admin':'fa-cog','teacher':'fa-chalkboard-teacher','student':'fa-user-graduate'}.get(u.role, 'fa-user') %}
                <span class="badge text-bg-light border">
                  <i class="fas {{ role_icon }} me-1"></i>{{ {'admin':'Админ','teacher':'Преподаватель','student':'Студент'}.get(u.role, u.role) }}
                </span>
              </td>
              <td>
                {% if u.is_active %}
                  <span class="badge text-bg-success">Активен</span>
                {% else %}
                  <span class="badge text-bg-secondary">Заблокирован</span>
                {% endif %}
              </td>
              <td>{{ u.last_login.strftime('%d.%m.%Y %H:%M') if u.last_login else '—' }}</td>
              <td>{{ u.created_at.strftime('%d.%m.%Y') if u.created_at else '—' }}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('admin.edit_user', user_id=u.id) }}"
                     class="btn btn-outline-primary" title="Редактировать">
                    <i class="fas fa-edit"></i>
                  </a>

                  {# запретим удалять самого себя #}
                  {% if current_user.id != u.id %}
                    <a href="#"
                       class="btn btn-outline-danger"
                       title="Удалить"
                       data-bs-toggle="modal"
                       data-bs-target="#deleteUserModal"
                       data-user-id="{{ u.id }}"
                       data-user-name="{{ u.get_full_name() }} ({{ u.username }})">
                      <i class="fas fa-trash"></i>
                    </a>
                  {% else %}
                    <button type="button" class="btn btn-outline-secondary" disabled title="Нельзя удалить свою учётную запись">
                      <i class="fas fa-lock"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <button type="button" class="btn btn-info" onclick="exportSelectedUsers()" id="exportSelectedUsersBtn" disabled>
        <i class="fas fa-download"></i> Экспорт выбранных
      </button>
      <span class="text-muted ms-2">Выбрано: <span id="selectedUsersCount">0</span></span>
    </div>
  {% else %}
    <div class="alert alert-info">
      <h4 class="mb-1">Пользователи не найдены</h4>
      <p class="mb-3">Создайте первого пользователя или импортируйте список из файла.</p>
      <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">Добавить пользователя</a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importUsersModal">Импорт пользователей</button>
    </div>
  {% endif %}

  {# Шаблон URL — JS подставит реальный в модалке удаления #}
  {% set delete_user_url_template = "__URL__" %}

  {# Пояснение формата импорта пользователей #}
  {% set users_format_note %}
    <div class="alert alert-info small mb-3">
      <strong>Формат JSON:</strong>
<pre class="mb-0">[
  {
    "username": "student1",
    "password": "pass12345",
    "role": "student",
    "email": "student1@example.com",
    "first_name": "Иван",
    "last_name": "Иванов",
    "is_active": true
  }
]</pre>
      <div class="small text-muted mt-2">role: <code>student</code> | <code>teacher</code> | <code>admin</code></div>
    </div>
  {% endset %}

  {# Модалка подтверждения удаления пользователя (Flask-WTF form) #}
  {% call confirm_modal(
      id='deleteUserModal',
      title='Удаление пользователя',
      body='Вы действительно хотите удалить пользователя <strong id="deleteUserName"></strong>?',
      action=delete_user_url_template,
      confirm_text='Удалить навсегда',
      confirm_class='btn-danger',
      alert_note='Это действие нельзя отменить.'
  ) %}
    {{ delete_form.hidden_tag() }}
  {% endcall %}

  {# Модалка импорта пользователей (Flask-WTF form) #}
  {{ upload_modal(
      id='importUsersModal',
      title='Импорт пользователей',
      action=url_for('admin.import_users'),
      input_name='file',
      accept='.json',
      submit_text='Импортировать',
      method='post',
      csrf_html=import_form.hidden_tag(),
      header_note=users_format_note
  ) }}

{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script>
    // Передаём URL экспорта в внешний JS
    window.USERS_EXPORT_URL = "{{ url_for('admin.export_users') }}";
  </script>
  <script src="{{ url_for('static', filename='js/admin_users.js') }}"></script>
{% endblock %}
