{% from "shared/modals.html" import confirm_modal, upload_modal %}
{% extends "admin/base_admin.html" %}

{% block title %}Управление заданиями{% endblock %}

{% block admin_content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-info-emphasis"><i class="fa fa-tasks"></i> Управление заданиями</h2>
    <div class="btn-group" role="group">
      <a href="{{ url_for('admin.create_task') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Создать задание
      </a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTasksModal">
        <i class="fas fa-upload"></i> Импорт
      </button>
      <a href="{{ url_for('admin.export_tasks') }}" class="btn btn-info">
        <i class="fas fa-download"></i> Экспорт всех
      </a>
    </div>
  </div>

  {# Фильтр по теме - если нужен #}
  {% if topics %}
  <form class="row g-2 align-items-end mb-3" method="get" action="{{ url_for('admin.tasks') }}">
    <div class="col-sm-8 col-md-6 col-lg-4">
      <label for="topic_id" class="form-label mb-1">Фильтр по теме</label>
      <select id="topic_id" name="topic_id" class="form-select">
        <option value="">Все темы</option>
        {% for t in topics %}
          <option value="{{ t.id }}" {% if request.args.get('topic_id')|int == t.id %}selected{% endif %}>
            {{ t.name }}{% if t.code %} ({{ t.code }}){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary">Показать</button>
    </div>
    {% if request.args.get('topic_id') %}
    <div class="col-auto">
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.tasks') }}">Сбросить</a>
    </div>
    {% endif %}
  </form>
  {% endif %}

  {% if tasks and tasks|length > 0 %}
    <div class="table-container">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:36px;"><input type="checkbox" id="selectAll"></th>
            <th>Название</th>
            <th>Тема</th>
            <th>Сложность</th>
            <th>Тип ответа</th>
            <th>Макс. балл</th>
            <th>Активна</th>
            <th>Создано</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks %}
          <tr>
            <td><input type="checkbox" class="task-checkbox" value="{{ task.id }}"></td>
            
            <td>
              <strong>{{ task.title or '—' }}</strong>
              {% if task.description %}
                <div class="small text-muted">{{ task.description[:80] }}{% if task.description|length > 80 %}…{% endif %}</div>
              {% endif %}
            </td>

            <td>
              {{ (task.topic_ref.name if task.topic_ref else '—') }}
              {% if task.topic_ref and task.topic_ref.code %}
                <div class="small text-muted"><code>{{ task.topic_ref.code }}</code></div>
              {% endif %}
            </td>

            <td>
              <span class="badge
                {% if task.level == 'low' %} bg-success text-light
                {% elif task.level == 'medium' %} bg-warning text-light
                {% elif task.level == 'high' %} bg-danger text-light
                {% else %} bg-secondary{% endif %}">
                {% if task.level == 'low' %}Низкий
                {% elif task.level == 'medium' %}Средний
                {% elif task.level == 'high' %}Высокий
                {% else %}{{ task.level|default('—') }}{% endif %}
              </span>
            </td>

            <td>
              {% if task.answer_type == 'number' %}
                <span>Число</span>
              {% elif task.answer_type == 'variables' %}
                <span>Переменные</span>
              {% elif task.answer_type == 'interval' %}
                <span>Интервал</span>
              {% elif task.answer_type == 'sequence' %}
                <span>Последовательность</span>
              {% else %}
                <span>—</span>
              {% endif %}
            </td>

            <td>{{ (task.max_score if task.max_score is not none else 0) }}</td>

            <td>
              {% if task.is_active %}<span class="badge bg-primary">да</span>
              {% else %}<span class="badge bg-secondary">нет</span>{% endif %}
            </td>

            <td>{{ task.created_at.strftime('%d.%m.%Y') if task.created_at else '—' }}</td>

            <td>
              <div class="btn-group btn-group-sm">
                <a href="{{ url_for('admin.edit_task', task_id=task.id) }}"
                   class="btn btn-outline-primary" title="Редактировать">
                  <i class="fas fa-edit"></i>
                </a>
                
                <a href="#"
                   class="btn btn-outline-danger"
                   title="Удалить"
                   data-bs-toggle="modal"
                   data-bs-target="#deleteTaskModal"
                   data-task-id="{{ task.id }}"
                   data-task-name="{{ task.title }}"
                   data-delete-url="{{ url_for('admin.delete_task', task_id=task.id) }}">
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-3">
      <button type="button" class="btn btn-info" onclick="exportSelected()" id="exportSelectedBtn" data-action="{{ url_for('admin.export_tasks') }}" disabled>
        <i class="fas fa-download"></i> Экспорт выбранных
      </button>
      <span class="text-muted ms-2">Выбрано: <span id="selectedCount">0</span></span>
    </div>
  {% else %}
    <div class="alert alert-info">
      <h4 class="mb-1">Задания не найдены</h4>
      <p class="mb-3">Создайте первое задание или импортируйте задания из файла.</p>
      <a href="{{ url_for('admin.create_task') }}" class="btn btn-primary">Создать задание</a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importTasksModal">Импорт заданий</button>
    </div>
  {% endif %}

  {# Модальное окно удаления задания #}
  {% call confirm_modal(
      id='deleteTaskModal',
      title='Удаление задания',
      body='Вы действительно хотите удалить задание <strong id="deleteTaskName"></strong>?',
      action=url_for('admin.delete_task', task_id=0),
      confirm_text='Удалить навсегда',
      confirm_class='btn-danger',
      alert_note='Это действие нельзя отменить. Все попытки решения этого задания также будут удалены.'
  ) %}
    {% if delete_form %}{{ delete_form.hidden_tag() }}{% else %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
  {% endcall %}

  {# Модальное окно импорта заданий #}
  {% set tasks_format_note %}
    <div class="alert alert-info small mb-3">
      <strong>Формат:</strong>
<pre class="mb-0">[
  {
    "title": "Квадратные уравнения. Базовая",
    "description": "Решите уравнение x² + 2x - 3 = 0",
    "answer_type": "number|variables|interval|sequence",
    "correct_answer": {"type": "number", "value": 42},
    "answer_schema": {},
    "explanation": "Подсказка к решению...",
    "topic_code": "quadratic_equations",
    "level": "low|medium|high",
    "max_score": 1.0,
    "is_active": true
  }
]</pre>
    </div>
  {% endset %}

  {{ upload_modal(
      id='importTasksModal',
      title='Импорт заданий',
      action=url_for('admin.import_tasks'),
      input_name='file',
      accept='.json',
      submit_text='Импортировать',
      method='post',
      csrf_html=import_form.hidden_tag() if import_form else '<input type="hidden" name="csrf_token" value="' + csrf_token() + '">',
      header_note=tasks_format_note
  ) }}

{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/admin_tasks.js') }}"></script> 
{% endblock %}