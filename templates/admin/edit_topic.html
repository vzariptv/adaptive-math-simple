{# templates/admin/edit_topic.html #}
{% extends "admin/base_admin.html" %}
{% from "shared/_form_macros.html" import render_field %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="fa fa-edit text-info-emphasis"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã</h2>
  <a href="{{ url_for('admin.topics') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç–µ–º–∞–º
  </a>
</div>

{% if form.errors %}
  <div class="alert alert-danger">
    <h5 class="mb-2">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã:</h5>
    <ul class="mb-0">
      {% for field_name, field_errors in form.errors.items() %}
        {% for err in field_errors %}
          <li>
            <strong>{{ form[field_name].label.text if form[field_name] else field_name }}</strong>: {{ err }}
          </li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h3 class="mb-3">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

    <form action="{{ url_for('admin.edit_topic', topic_id=topic.id) }}" method="post" novalidate class="topic-form">
      {{ form.hidden_tag() }}

      <div class="row g-3">
        <div class="col-md-6">
          <div class="d-flex justify-content-between align-items-center">
            <label for="{{ form.code.id }}" class="form-label mb-0">
              {{ form.code.label.text }}{% if form.code.flags.required %} <span class="text-danger">*</span>{% endif %}
            </label>
            <button type="button" id="slugifyBtn" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-wand-magic-sparkles"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
            </button>
          </div>

          {{ form.code(class_=('form-control' ~ (' is-invalid' if form.code.errors else ''))) }}
          {% if form.code.errors %}
            <div class="invalid-feedback">{{ form.code.errors[0] }}</div>
          {% elif form.code.description %}
            <div class="form-text">{{ form.code.description }}</div>
          {% endif %}
        </div>

        <div class="col-md-6">
          {{ render_field(form.name) }}
        </div>
      </div>

      <div class="mt-3">
        {{ render_field(form.description) }}
      </div>

      <div class="alert alert-warning mt-3">
        <i class="fas fa-triangle-exclamation"></i>
        –ë—É–¥—å—Ç–µ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ <strong>–∫–æ–¥–∞ —Ç–µ–º—ã</strong> ‚Äî —ç—Ç–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.
      </div>

      <hr class="my-4">

      <h3 class="mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π</h3>
      <div class="row gy-3">
        {# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ç—Ä–∏ –ø–æ–¥—Ñ–æ—Ä–º—ã –≤ FieldList: low, medium, high #}
        {% for cfg in form.configs %}
          {% set lvl = cfg.level.data or cfg.level._value() %}
          <div class="col-md-4">
            <div class="p-3 bg-light rounded border-start border-4
                {% if lvl == 'low' %}border-success{% elif lvl == 'medium' %}border-warning{% else %}border-danger{% endif %}">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                  {% if lvl == 'low' %}üü¢ –ù–∏–∑–∫–∏–π{% elif lvl == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π{% else %}üî¥ –í—ã—Å–æ–∫–∏–π{% endif %}
                </h6>
              </div>

              {{ cfg.level() }}  {# HiddenField —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É—Ä–æ–≤–Ω—è #}

              <div class="mb-2">
                {{ render_field(cfg.task_count_threshold) }}
              </div>
              <div class="mb-2">
                {{ render_field(cfg.reference_time) }}
              </div>
              <div class="mb-0">
                {{ render_field(cfg.penalty_weights) }}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mt-4 d-flex align-items-center gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
        <a href="{{ url_for('admin.topics') }}" class="btn btn-outline-secondary">
          <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </a>
      </div>
    </form>
  </div>
</div>

{% if topic.created_at %}
  <div class="text-muted small">–°–æ–∑–¥–∞–Ω–æ: {{ topic.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
{% endif %}
{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script>
    // –ö–Ω–æ–ø–∫–∞ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è¬ª ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç code –Ω–∞ –æ—Å–Ω–æ–≤–µ name.
    (function () {
      const nameInput = document.getElementById('{{ form.name.id }}');
      const codeInput = document.getElementById('{{ form.code.id }}');
      const btn = document.getElementById('slugifyBtn');
      if (!nameInput || !codeInput || !btn) return;

      function translitRuToEn(s) {
        const ru = '–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è';
        const en = ['a','b','v','g','d','e','e','zh','z','i','y','k','l','m','n','o',
                    'p','r','s','t','u','f','h','ts','ch','sh','sch','','y','','e','yu','ya'];
        return s.replace(/[–ê-–Ø–Å–∞-—è—ë]/g, ch => {
          const lower = ch.toLowerCase();
          const idx = ru.indexOf(lower);
          const tr = idx >= 0 ? en[idx] : '';
          return ch === lower ? tr : tr.toUpperCase();
        });
      }

      btn.addEventListener('click', function () {
        const base = nameInput.value || '';
        const draft = translitRuToEn(base)
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '');
        codeInput.value = draft;
        codeInput.focus();
      });
    })();
  </script>
{% endblock %}
