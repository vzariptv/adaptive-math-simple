{# templates/admin/create_topic.html #}
{% extends "admin/base_admin.html" %}
{% from "shared/_form_macros.html" import render_field %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º—ã{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="fa fa-book text-info-emphasis"></i> –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ–º—ã</h2>
  <a href="{{ url_for('admin.topics') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Ç–µ–º–∞–º
  </a>
</div>

{# –°–≤–æ–¥–Ω–∞—è –ø–∞–Ω–µ–ª—å –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã (—É–¥–æ–±–Ω–æ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö —Å—Ä–∞–∑—É) #}
{% if form.errors %}
  <div class="alert alert-danger">
    <h5 class="mb-2">–û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–º—ã:</h5>
    <ul class="mb-0">
      {% for field_name, field_errors in form.errors.items() %}
        {% for err in field_errors %}
          <li>
            <strong>{{ getattr(form, field_name).label.text if form[field_name] else field_name }}</strong>:
            {{ err }}
          </li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h3 class="mb-3">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

    {# –í–ê–ñ–ù–û: Flask-WTF —Ñ–æ—Ä–º–∞. hidden_tag() –¥–æ–±–∞–≤–∏—Ç CSRF –∏ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è. #}
    <form action="{{ url_for('admin.create_topic') }}" method="post" class="topic-form" novalidate>
      {{ form.hidden_tag() }}

      <div class="row g-3">
        <div class="col-md-6">
          {{ render_field(form.name) }}
        </div>
        <div class="col-md-6">
            {{ render_field(form.code) }}
        </div>
      </div>

      <div class="mt-3">
        {{ render_field(form.description) }}
      </div>

      <div class="alert alert-info mt-3">
        <h6 class="mb-2"><i class="fas fa-info-circle"></i> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h6>
        <p class="mb-0">
          –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
          (–Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –≤—ã—Å–æ–∫–∏–π) —Å –±–∞–∑–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏. –ò—Ö –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–º—ã.
        </p>
      </div>

      <div class="mt-3 d-flex align-items-center gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> –°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É
        </button>
        <a href="{{ url_for('admin.topics') }}" class="btn btn-outline-secondary">
          <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </a>
      </div>
    </form>
  </div>
</div>

{# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫-–ø—Ä–µ–≤—å—é —É—Ä–æ–≤–Ω–µ–π (–±–µ–∑ –ª–æ–≥–∏–∫–∏; –ø—Ä–æ—Å—Ç–æ UI) #}
<div class="card">
  <div class="card-body">
    <h3 class="mb-3">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π</h3>

    <div class="row gy-3">
      <div class="col-md-4">
        <div class="p-3 bg-light rounded border-start border-4 border-success">
          <h6 class="mb-2">üü¢ –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</h6>
          <ul class="list-unstyled mb-0 small text-muted">
            <li><strong>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:</strong> 10</li>
            <li><strong>–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:</strong> 15 –º–∏–Ω</li>
            <li><strong>–®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø–æ–ø—ã—Ç–∫–∏:</strong> [0.7, 0.4]</li>
          </ul>
        </div>
      </div>

      <div class="col-md-4">
        <div class="p-3 bg-light rounded border-start border-4 border-warning">
          <h6 class="mb-2">üü° –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</h6>
          <ul class="list-unstyled mb-0 small text-muted">
            <li><strong>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:</strong> 10</li>
            <li><strong>–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:</strong> 15 –º–∏–Ω</li>
            <li><strong>–®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø–æ–ø—ã—Ç–∫–∏:</strong> [0.7, 0.4]</li>
          </ul>
        </div>
      </div>

      <div class="col-md-4">
        <div class="p-3 bg-light rounded border-start border-4 border-danger">
          <h6 class="mb-2">üî¥ –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</h6>
          <ul class="list-unstyled mb-0 small text-muted">
            <li><strong>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:</strong> 10</li>
            <li><strong>–≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:</strong> 15 –º–∏–Ω</li>
            <li><strong>–®—Ç—Ä–∞—Ñ—ã –∑–∞ –ø–æ–ø—ã—Ç–∫–∏:</strong> [0.7, 0.4]</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="alert alert-secondary mt-3 mb-0 small">
      <i class="fas fa-lightbulb"></i>
      –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–º—ã –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    </div>
  </div>
</div>
{% endblock %}

{# –°–∫—Ä–∏–ø—Ç –∫–ª–∞–¥—ë–º –≤ extra_js, —á—Ç–æ–±—ã –æ–Ω –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ <body> #}
{% block extra_js %}
  {{ super() }}
  <script>
  // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è "code" –∏–∑ "name" —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–µ –º–µ–Ω—è–ª –ø–æ–ª–µ code.
  (function () {
      const nameInput = document.getElementById('{{ form.name.id }}');
      const codeInput = document.getElementById('{{ form.code.id }}');
      if (!nameInput || !codeInput) return;

      // –§–ª–∞–∂–æ–∫: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∞–≤–∏–ª –ø–æ–ª–µ "code"?
      let codeDirty = false;

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—Ç–æ-—Ç–æ –≤–≤–æ–¥–∏–ª –≤ –ø–æ–ª–µ –∫–æ–¥–∞ ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é
      codeInput.addEventListener('input', function () {
        codeDirty = true;
      });

      // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è RU‚ÜíEN
      function translitRuToEn(s) {
        const ru = '–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è';
        const en = ['a','b','v','g','d','e','e','zh','z','i','y','k','l','m','n','o',
                    'p','r','s','t','u','f','h','ts','ch','sh','sch','','y','','e','yu','ya'];
        return s.replace(/[–ê-–Ø–Å–∞-—è—ë]/g, ch => {
          const lower = ch.toLowerCase();
          const idx = ru.indexOf(lower);
          const tr = idx >= 0 ? en[idx] : '';
          return ch === lower ? tr : tr.toUpperCase();
        });
      }

      // –ü–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø—Ä–∞–≤–∏–ª –ø–æ–ª–µ –∫–æ–¥–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ –∫–∞–∂–¥—ã–π –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è
      nameInput.addEventListener('input', function () {
        if (codeDirty) return;  // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–∞–≤–∏–ª –∫–æ–¥ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
        const draft = translitRuToEn(this.value)
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '');
        codeInput.value = draft;
      });

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—á–∏—Å—Ç–∏–ª –ø–æ–ª–µ –∫–æ–¥–∞, —Å–Ω–æ–≤–∞ —Ä–∞–∑—Ä–µ—à–∏–º –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é
      codeInput.addEventListener('blur', function () {
        if (!codeInput.value) codeDirty = false;
      });
    })();
  </script>
{% endblock %}
